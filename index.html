<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>JD RAG - ITSM Executive Assistant</title>
    <!-- Use Tailwind CSS for styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
        }
        /* Custom scrollbar style for chat history */
        #chat-history::-webkit-scrollbar {
            width: 8px;
        }
        #chat-history::-webkit-scrollbar-thumb {
            background-color: #d1d5db; /* gray-300 */
            border-radius: 4px;
        }
        /* Custom styles for chat bubbles */
        .user-bubble {
            background-color: #1d4ed8; /* blue-700 */
            color: white;
            border-bottom-right-radius: 0;
        }
        .assistant-bubble {
            background-color: #e5e7eb; /* gray-200 */
            color: #1f2937; /* gray-900 */
            border-bottom-left-radius: 0;
        }
    </style>
</head>
<body class="bg-gray-100 flex items-center justify-center min-h-screen p-4">

    <!-- Main Container -->
    <div class="bg-white rounded-xl shadow-2xl overflow-hidden w-full max-w-2xl flex flex-col h-[90vh] md:h-[80vh]">
        <div class="p-6 bg-blue-600 text-white shadow-lg">
            <h1 class="text-2xl font-bold">ITSM Executive Assistant</h1>
            <p class="text-sm opacity-90">Ask questions about incident trends, root causes, and performance.</p>
        </div>

        <!-- Chat History Area -->
        <div id="chat-history" class="flex-grow p-4 overflow-y-auto space-y-4">
            <!-- Initial Greeting -->
            <div class="flex justify-start">
                <div class="max-w-xs md:max-w-md p-3 rounded-lg assistant-bubble shadow-md">
                    Hello! I'm your RAG-powered ITSM assistant. How can I help you analyze your incident data today?
                </div>
            </div>
        </div>

        <!-- Input Area -->
        <div class="p-4 border-t border-gray-200">
            <div class="flex items-center space-x-3">
                <input type="text" id="query-input" placeholder="E.g., What is the root cause for high priority incidents in Q4?"
                       class="flex-grow p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 transition duration-150">
                <button id="search-button"
                        class="bg-blue-600 hover:bg-blue-700 text-white p-3 rounded-lg shadow-md transition duration-150 flex items-center justify-center w-12 h-12">
                    <!-- Send Icon (Default) -->
                    <svg id="send-icon" class="w-6 h-6 transform rotate-45 -mt-1" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8"></path>
                    </svg>
                    <!-- Loading Indicator (Hidden by Default) -->
                    <svg id="loading-indicator" class="hidden animate-spin w-5 h-5 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                    </svg>
                </button>
            </div>
        </div>
    </div>

    <script>
        const queryInput = document.getElementById('query-input');
        const searchButton = document.getElementById('search-button');
        const chatHistory = document.getElementById('chat-history');
        const loadingIndicator = document.getElementById('loading-indicator');
        const sendIcon = document.getElementById('send-icon');

        /**
         * Appends a message bubble to the chat history.
         * @param {string} role - 'user' or 'assistant'.
         * @param {string} text - The message text.
         */
        function appendMessage(role, text) {
            const isUser = role === 'user';
            const alignment = isUser ? 'justify-end' : 'justify-start';
            const bubbleClass = isUser ? 'user-bubble' : 'assistant-bubble';

            const messageDiv = document.createElement('div');
            messageDiv.className = `flex ${alignment}`;

            const bubbleDiv = document.createElement('div');
            // Use whitespace-pre-wrap to handle potential newlines in error messages gracefully
            bubbleDiv.className = `max-w-xs md:max-w-md p-3 rounded-xl shadow-md ${bubbleClass} whitespace-pre-wrap`;
            bubbleDiv.innerText = text;

            // Apply different rounded corners for the tail effect
            if (isUser) {
                bubbleDiv.classList.add('border-b-4', 'border-r-2');
            } else {
                bubbleDiv.classList.add('border-b-4', 'border-l-2');
            }

            messageDiv.appendChild(bubbleDiv);
            chatHistory.appendChild(messageDiv);

            // Scroll to the bottom
            chatHistory.scrollTop = chatHistory.scrollHeight;
        }

        async function handleSearch() {
            const query = queryInput.value.trim();
            if (!query) return;

            // 1. Display user query and clear input
            appendMessage('user', query);
            queryInput.value = '';

            // 2. Set loading state
            searchButton.disabled = true;
            loadingIndicator.classList.remove('hidden');
            sendIcon.classList.add('hidden');

            try {
                const response = await fetch('/query', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ query: query })
                });
                
                // Read the response body as text ONCE.
                const responseText = await response.text();
                let data;
                
                try {
                    // Attempt to parse the text as JSON
                    data = JSON.parse(responseText);

                    if (!response.ok) {
                        // Handle API errors where the server returned a JSON error object (e.g., 400, 500)
                        const errorMessage = data.error || `HTTP error! status: ${response.status}`;
                        throw new Error(errorMessage);
                    }
                    
                    // Success: Display assistant's answer
                    appendMessage('assistant', data.answer);

                } catch (e) {
                    // This catches both JSON parsing errors (SyntaxError) and the custom Error thrown above.
                    let displayError = e.message;

                    // If it was a JSON parsing error, the server returned something unexpected (like HTML).
                    if (e instanceof SyntaxError) {
                         // Check if the response looks like HTML (starts with <)
                        const isHtml = responseText.trim().startsWith('<');
                        
                        displayError = `The backend returned an unexpected format (HTTP status: ${response.status}).`;
                        
                        if (isHtml) {
                            displayError += ` The server likely encountered an unhandled Python error. Please check Cloud Run logs for the full traceback. Raw content start: ${responseText.trim().substring(0, 150)}...`;
                        } else {
                            // If it's not HTML, just show the start of the raw text
                            displayError += ` Raw content start: ${responseText.trim().substring(0, 150)}...`;
                        }
                    }
                    
                    // Re-throw the error to be caught by the outer catch block
                    throw new Error(displayError);
                }

            } catch (error) {
                console.error('Error fetching data:', error);
                // Display error message to the user
                appendMessage('assistant', `⚠️ **An error occurred:** ${error.message}`);
            } finally {
                // Hide loading state
                searchButton.disabled = false;
                loadingIndicator.classList.add('hidden');
                sendIcon.classList.remove('hidden');
            }
        }

        // Attach event listeners
        searchButton.addEventListener('click', handleSearch);
        queryInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                handleSearch();
            }
        });
    </script>
</body>
</html>
